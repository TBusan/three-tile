## V0.7计划

2020年，单位整体更换信创国产软硬件，只剩了部分十年前的X86电脑，开发three-tile的原因之一就是想搞一套占用资源低的三维地图开发框架，能在低配置电脑上流畅运行，最好能在信创电脑上运行（想多了）。

在V0.6.4之前，three-tile会严格控制资源占用，基本上做到了极致，牺牲了一些用户体验，最明显的表现就是地图在缩放、旋转中，新进入可视区域的瓦片加载过程会先出现空白块，直到数据加载完成才能显示。

最近突然发现：没几个人还在用我的这种4G内存的垃圾电脑了，为支持它牺牲效果得不偿失，同时，为了节省资源，three-tile的瓦片调度逻辑十分复杂，一些不易捕捉的bug始终无法解决。2025即将到来，没必要再追求低资源占用，在V0.7.0中重写瓦片调度策略，以用户体验作为首要目标。

---

V0.6.4及之前版本回顾：


要节省资源，需要尽量做到不下载、不保存、不解析、不渲染不必要的瓦片，什么是不必要的瓦片呢：

1. 不在可视范围的瓦片
2. 非叶子瓦片

> 主流三维瓦片地图框架，地图瓦片从瓦片树自顶向下顺序加载，不会考虑它们是否在可视范围，也就是看得见看不见的都下载解析保存，资源占用较大，而瓦片树中真正需要显示的仅是可视范围的叶子瓦片，一般仅占总瓦片数量的30%左右，甚至更低，理论上来说，如果按需加载渲染会大幅提升运行效率。

three-tile采用按需加载的瓦片调度策略：

1. 仅构建可视范围瓦片树：仅创建视椎体内的瓦片，这个是必须的。
2. 瓦片树更新与数据加载独立运行：先更新瓦片树，待瓦片树构建完成后再加载可视叶子瓦片数据。
3. 乱序下载：即下载不按瓦片树层级一级一级顺序下载，需要显示那块下载那块。
4. 用完立即释放：瓦片一旦离开视椎体或成为非叶子瓦片，立即释放，需要显示再重新下载。
5. 下载可以终止：如果正在下载瓦片状态变为非可视，立即中止下载并释放。

设想很美好，但做到并不容易，解决一个问题可能会带来一个更大的问题：

1. 瓦片如果按需加载显示，没有缓存，那么新进入视野中的瓦片需要等数据下载完才能显示出来，会先显示空白块，十分影响体验。
2. 瓦片一旦离开视椎体或成为非叶子瓦片立即释放，需要显示时再重新下载，数据会多次重复下载，故做了一个下载缓存器，保存最近下载的瓦片数据。
3. 子瓦片下载完成后，不能直接显示，需要等它的兄弟瓦片都下载完成，但它的父瓦片可能是爷爷太爷爷级的，子子孙孙一大堆，全部下载完成耗时较长，用户看到的是一片白认为是卡住，无奈子瓦片先显示成了wireframe已表示它还活着。
4. 地图在缩放旋转过程中，可视范围变动太频繁，会不断加载、释放瓦片，甚至出现抖动，不得不增加了渲染缓冲区，即在判断瓦片是否在视椎体中时，适当扩大视椎体范围，多加载一些瓦片。
5. 每级瓦片都必须从大到小加载，无法真正做到按需加载，例如瓦片从2级放大到10级，但它肯定是经过2-9级才到的10级，虽然2-9级一闪而过，但只要经过就会启动下载。
6. 设计了多瓦片下载并行，但浏览器限制一个服务地址同时只能有6个连接同时下载，超出的会暂时挂起，实际上仍会按请求先后顺序下载。原本设计下载子瓦片时中止父瓦片下载，但大部分情况父瓦片下载时子瓦片还是挂起，根本没机会中止。

问题一大堆，费九牛二虎之力解决后，终于能在垃圾电脑上跑满60fps，但用户体验却变差，程序逻辑也十分复杂，以至于我自己都不敢大动这块代码。

> 相比cesium等，你的低资源占用优势没人在乎，甚至感觉不到，缺点却摆在明面一览无遗，是时候改变了。

--- 

V0.7.0更新

1. 瓦片树上瓦片改为全部加载，不再判断是否在可视范围。
2. 瓦片创建后立即下载，不再等待瓦片树更新完成。
3. 瓦片用完也不再释放留着做缓存，直到从瓦片树上删除。
4. 渲染缓冲区没有存在必要，现在相当于缓冲区已变成无限大。
5. 因为瓦片下载并不释放，下载缓存也已经不重要，但费了很大劲写出来了，先留着。
6. 乱序加载逻辑太复杂，改为自顶向下顺序加载，地图加载时能看到瓦片一级一级细化过程（暂未完成）。
7. 去掉瓦片加载期间的wireframe方式显示，计划做个瓦片加载淡入动画。
8. 瓦片加载器接口删除下载错误回调函数参数，下载错误时按走成功下载回调返回一个特定的瓦片。
9. TileMap类增加地理坐标与世界坐标转换函数，前面需要地坐标->瓦片坐标->世界坐标，现在直接转换。

V0.7.0 重写了瓦片调度策略，删除了大量核心代码，有些伤感，当年为了实现按需加载熬了多少个深夜，现在全删了。

目前测试效果：
1. 不会出现加载期间的空白瓦片，地图能覆盖全部窗口范围。
2. 因为threejs内置视椎体剔除功能，不可视瓦片不会被渲染，不会增加GPU负担，对渲染效率影响不大。
3. 因为保存了瓦片树上所有瓦片，内存占用大幅增加，多增加几十兆内存占用，应该没多少人在乎吧？
4. 因为需要下载瓦片树上所有瓦片，数据下载量大幅增加，网速慢的影响较大，但浏览器有下载缓存，仅初次下载较慢。
5. 下载后需要解析生成瓦片模型，下载量大意味这解析瓦片计算量大，CPU负担加重。

--- 

总结：
1. 新的想法需要实践后才能知道是否可行，一些些貌似很好的想法主流软件没有采用是有原因的？不是因为大神们没想到，而是他们试了不可行或效果较差。
2. 按需加载瓦片貌似是一个节省资源的好方法，但在地图的频繁缩放旋转中，你完全不知道下一秒地图会转到哪里，前一秒刚释放，后一秒有可能又需要加载，与其开辟缓存保存数据，还不如加载全量瓦片。
3. 地图数据乱序加载貌似可以只加载可视瓦片减少下载量，但地图放大中瓦片需要先经过低级别瓦片才能到高级别，低级别瓦片虽然只是过渡一下，但大部分时候仍需要下载（可以中止下载），顺序加载可以让用户看到瓦片一级一级细化过程，有更好的用户体验。